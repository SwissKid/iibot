#!/bin/bash
owner="swiss"
nick="swissboxbot"
server="irc.freenode.net"
channel="#swisstest"
ircdir="/home/swiss/testing/"
function msgowner() {
echo "/privmsg $owner :$@" > "$ircdir$server/in"
}

trap control_c SIGINT
#ctrl-c inttrupt
function control_c() {
	echo -e "quitting\n"
	rm -r $ircdir$server/*
	mkdir $ircdir$server/$owner/
	touch $ircdir$server/$owner/out
	kill -9 "$iipid"
	exit 0
	}

#command grabbing
function commandme(){
	tailf -n1 "$ircdir$server/$channel/out" | while read -r date time nick msg; do 
	echo $nick $msg
	if [ "$(echo $msg | head -c 1)" == '!' ]; then
		set -- $msg
		start=$1
		shift
		rest=$@
		command=$(echo $start | sed -e "s/^!//")
		
		##Time to start writing what commands do
		if [ "$command" == 'search' ] || [ "$command" == 'Search' ]; then
			echo "/privmsg @channel `./anime $rest`"
		fi
			

	fi
	done
}

function ownermessage(){
	tailf -n1 "$ircdir$server/$owner/out" | while read -r date time nick msg; do
		set -- $msg
		i=$1
		shift
		channel=$1
		shift
		message=$@
		echo "Master wants me to $i $channel and $message"
		if [ "$(echo $channel | head -c 1)" != "#" ]; then
			echo $channel
			newchannel=$(echo "#""$channel")
			channel="$newchannel"
			echo $newchannel
		fi


		#Join
		if [ "$i" == 'j' ] || [ "$i" == 'join' ]; then
			echo "/j $channel"
			echo "/j $channel" > "$ircdir$server/in"
			echo "/privmsg $owner :Joining $channel" > "$ircdir$server/in"
			commandme &
		
		#Speak
		elif [ "$i" == 'say' ] || [ "$i" == 'Say' ]; then
			echo "/privmsg $channel :$message"
	
		#Part
		elif [ "$i" == 'q' ] || [ "$i" == 'part'] || [ "$i" == 'p' ]; then
			echo "$msg"
			msgowner Parting $channel with message $message
			echo "/part $channel :$message" > "$ircdir$server/in"

		#Quit
		elif [ "$i" == 'quit' ] || [ "$i" == 'Quit' ]; then
			echo "quit"
			msgowner Shutting Down
			control_c
		fi

	done & 
}

while true; do
	./ii -s $server -n $nick -f "Iamabot" -i $ircdir &
	iipid="$!"
	sleep 5
	for i in $channel; do
		echo "/j $i" > $ircdir/$server/in
	done
	echo "/privmsg $owner :I AM READY" > $ircdir/$server/in
	ownermessage
	wait "$iipid"
done 




